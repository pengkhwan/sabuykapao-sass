---
// src/components/SanityImage.astro (เวอร์ชัน Fixed)
import { Image } from 'astro:assets';
import { urlFor } from '../lib/sanityImageUrl';

const { node, type = 'body' } = Astro.props;
if (!node || !node.asset) {
  return null;
}

// 1. กำหนดขนาดเป้าหมายตาม type
const TARGET_SIZES = {
  body: { pc: 400, tablet: 350, mobile: 280 },
  featured: { pc: 600, tablet: 500, mobile: 350 }
};

const currentSizes = TARGET_SIZES[type] || TARGET_SIZES.body;

// 2. ดึงขนาดต้นฉบับของรูปภาพ
const originalWidth = node.asset.metadata?.dimensions.width;
const originalHeight = node.asset.metadata?.dimensions.height;

// 3. คำนวณขนาดที่จะแสดงผลสำหรับ PC (ใช้ขนาดใหญ่กว่า)
let displayWidth = currentSizes.pc;
let displayHeight = currentSizes.pc; // Default to 1:1 ratio

if (originalWidth && originalHeight) {
  displayWidth = Math.min(originalWidth, currentSizes.pc);
  displayHeight = Math.round((displayWidth / originalWidth) * originalHeight);
}
---
<figure class={`${type}-image`}>
  <Image
    src={urlFor(node).width(displayWidth).quality(85).auto('format').url()}
    alt={node.alt || 'Image from content'}
    width={displayWidth} 
    height={displayHeight}
    format="webp"
    quality={85}
    loading="lazy"
    decoding="async"
  />
  {node.caption && <figcaption>{node.caption}</figcaption>}
</figure>

<style>
  figure {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-width: 100%;
    margin-inline: auto; 
    margin-block: 2em;
  }

  /* สำหรับรูปภาพใน body content */
  :global(figure.body-image img) {
    width: 400px;
    height: 400px;
    max-width: 100%;
    object-fit: cover;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    
    @media (max-width: 768px) {
      width: 280px;
      height: 280px;
    }
    
    @media (max-width: 1024px) and (min-width: 769px) {
      width: 350px;
      height: 350px;
    }
  }

  /* สำหรับ Featured Image */
  :global(figure.featured-image img) {
    width: 600px;
    height: 600px;
    max-width: 100%;
    object-fit: cover;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    
    @media (max-width: 768px) {
      width: 350px;
      height: 350px;
    }
    
    @media (max-width: 1024px) and (min-width: 769px) {
      width: 500px;
      height: 500px;
    }
  }

  figcaption {
    margin-top: 0.5em;
    font-size: 0.95rem;
    color: #555;
    font-style: italic;
    background-color: #F5F4F2;
    display: inline-block;
    padding: 0.25em 0.75em;
    border-radius: 4px;
    text-align: center;
  }
</style>