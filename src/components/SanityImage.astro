---
// src/components/SanityImage.astro (เวอร์ชัน Final)
import { Image } from 'astro:assets';
import { urlFor } from '../lib/sanityImageUrl';

const { node } = Astro.props;
if (!node || !node.asset) {
  return null;
}

// 1. กำหนดขนาดเป้าหมายใหม่เป็น 600px
const TARGET_WIDTH = 600;

// 2. ดึงขนาดต้นฉบับของรูปภาพ (จำเป็นต้องดึงข้อมูลนี้มาจาก [slug].astro)
const originalWidth = node.asset.metadata?.dimensions.width;
const originalHeight = node.asset.metadata?.dimensions.height;

// 3. คำนวณขนาดที่จะแสดงผลจริง
let displayWidth = TARGET_WIDTH;
let displayHeight = TARGET_WIDTH; // Default to 1:1 ratio if no dimensions

if (originalWidth && originalHeight) {
  displayWidth = Math.min(originalWidth, TARGET_WIDTH);
  displayHeight = Math.round((displayWidth / originalWidth) * originalHeight);
}
---
<figure>
  <Image
    src={urlFor(node).width(displayWidth).quality(85).auto('format').url()}
    alt={node.alt || 'Image from content'}
    width={displayWidth} 
    height={displayHeight}
    format="webp"
    quality={85}
    loading="lazy"
    decoding="async"
  />
  {node.caption && <figcaption>{node.caption}</figcaption>}
</figure>

<style>
  figure {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-width: 100%;
    margin-inline: auto; 
    margin-block: 2em;
  }

  :global(figure img) {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  figcaption {
    margin-top: 0.5em;
    font-size: 0.95rem;
    color: #555;
    font-style: italic;
    background-color: #F5F4F2;
    display: inline-block;
    padding: 0.25em 0.75em;
    border-radius: 4px;
    text-align: center;
  }
</style>